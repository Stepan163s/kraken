# Kraken Bot

Чат-бот для Telegram, “прикидывающийся” бывшим агентом КГБ под псевдонимом «Кракен». Он сохраняет контекст беседы, проявляет грубоватую манеру общения, ссылается на реальные политические и культурные тренды, а также ведёт «ночную» рефлексию для осмысления своей деятельности.

---

## Общая идея

1. **Чтение контекста и ответ**  
   - Бот запоминает предыдущие сообщения, формирует промпт в грубом стиле (см. [`STYLE_PROMPT`](./prompts.py)) и отвечает от лица «Кракена».  
   - Если пользователь задаёт вопрос, заканчивающийся “?”, или упоминает “кракен” — бот обрабатывает этот текст.

2. **Хранение данных**  
   - Все сообщения записываются в базу данных (см. [database.md](./documentation/database.md)).  
   - Параллельно можно сохранять статистику по участникам, количеству сообщений, мемам и т.д.

3. **Публикация статистики**  
   - Раз в минуту (для примера) сохраняется текущее число участников чата в таблицу `participants_statistics`.  
   - По команде `/stats` бот формирует и отправляет статистику за текущую и предыдущую недели (см. [`handlers.py`](./handlers.py)).

4. **Ночная рефлексия**  
   - В коде (см. [reflection.md](./documentation/reflection.md) и директорию [`sleep/`](./sleep/)) планируется логика «ухода в сон» и «ночных» диалогов бота с «коллективным разумом».  
   - Утром бот «просыпается», может поменять часть убеждений и признать ошибки (подробнее в [dream.md](./documentation/dream.md)).

5. **Работа с каналами**  
   - В [channels.md](./documentation/channels.md) описана логика публикаций в Telegram-каналах: «Дочка», «Ковенант» и «Новости».  
   - В коде уже есть заготовки для команд `/top`, `/stats`, а также планировщик (см. [`main.py`](./main.py)) для регулярных задач.

---

## Структура репозитория

kraken/
├─ .git/
├─ documentation/
│   ├─ architecture.md
│   ├─ channels.md
│   ├─ compression.md
│   ├─ database.md
│   ├─ dream.md
│   ├─ entities.md      <– перечислены все сущности проекта
│   ├─ prompts.md
│   └─ reflection.md
├─ knowledge/
├─ reflexion/
├─ sleep/
├─ speak/
├─ task/
├─ ai.py               <– базовая логика: ChatGPT, подключение к БД
├─ database.py         <– работа с PostgreSQL (save_message, get_*_statistics и др.)
├─ handlers.py         <– обработчики /stats, /top, сохранение входящих сообщений
├─ main.py             <– точка входа, включает планировщик
├─ prompts.py          <– STYLE_PROMPT, HOLIDAY_PROMPT и т.д.
├─ schema.sql          <– описание структуры БД (не показано в коде выше)
└─ README.md           <– (этот файл)

### Краткое описание документов в `documentation/`

- **[architecture.md](./documentation/architecture.md)**  
  Общее устройство бота: приём сообщений, дневной/ночной цикл, взаимодействие с базой данных.

- **[channels.md](./documentation/channels.md)**  
  Логика публикаций в каналы «Дочка», «Ковенант» и «Новости»: что, когда и куда отправляется.

- **[compression.md](./documentation/compression.md)**  
  Алгоритмы и идеи сжатия (подобно Хаффману), чтобы экономить ресурсы и место в БД.

- **[database.md](./documentation/database.md)**  
  Детали по структуре таблиц, связь между ними и нюансы использования PostgreSQL (или других СУБД).

- **[dream.md](./documentation/dream.md)**  
  Механизм “суммарной ночной рефлексии”, где бот анализирует сообщения за день и делает выводы.

- **[entities.md](./documentation/entities.md)**  
  Полный список ключевых переменных окружения, функций, классов, обработчиков — все сущности проекта.

- **[prompts.md](./documentation/prompts.md)**  
  Система формирования промптов (конструктор стилей). Примеры “политического”, “образовательного” и др. стилей.

- **[reflection.md](./documentation/reflection.md)**  
  Подробности о “ночном диалоге” бота с “коллективным разумом”, признании ошибок, записи опыта.

## Основные сущности и переменные

Все ключевые объекты, переменные окружения, функции и константы перечислены в [**entities.md**](./documentation/entities.md). Среди них:

- `BOT_TOKEN`, `CHAT_GPT_TOKEN`, `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_PORT` — переменные окружения.  
- `STYLE_PROMPT` — константа с описанием характерной грубой манеры общения.  
- `get_db_connection()`, `save_message()`, `get_message_statistics()` — функции для работы с БД.  
- `bot` (из модуля `TeleBot`) — основной объект, который слушает и обрабатывает сообщения.

## Текущие и планируемые модули

- **`ai.py`**  
  Хранит токены из `.env`, инициализирует `TeleBot`, определяет `STYLE_PROMPT` и функции для извлечения контекста из базы перед обращением к OpenAI.

- **`database.py`**  
  Предоставляет функции для сохранения и извлечения сообщений (`save_message`, `get_weekly_messages` и т.д.). Содержит логику для сбора статистики (количество сообщений, уникальных пользователей, участников чата).

- **`handlers.py`**  
  Обработчики команд `/top`, `/stats`, а также общий обработчик для любых сообщений. Внутри вызывается `save_message(...)` и формируется ответ бота.

- **`main.py`**  
  Инициализирует планировщик (APScheduler), который раз в минуту вызывает `update_statistics()`. Затем запускает бесконечный поллинг бота.

- **`prompts.py`**  
  Содержит заготовленные промпты вроде `HOLIDAY_PROMPT` и `STYLE_PROMPT`. В будущем здесь можно расширять набор стилистик и сценариев.

- **Папки `knowledge/`, `reflexion/`, `sleep/`, `speak/`, `task/`**  
  Хранят (или будут хранить) дополнительные модули: сбор информации, рефлексию бота, сценарии “сна” и утренней активности, генерацию выходного текста, логику рассылок по каналам и т.д.

## Как бот работает (коротко)

1. Пользователь пишет в чат:  
   - Если это вопрос (заканчивается “?”) или в тексте есть “кракен”, сообщение обрабатывается в `handle_message()`.
2. Функция `save_message(...)` заносит сообщение в БД (таблица `messages`).  
3. Из БД через `get_context_from_db()` (или аналоги) бот получает 20 (по умолчанию) предыдущих сообщений — это контекст.  
4. Формируется `full_prompt`, включающий `STYLE_PROMPT`, контекст и сам вопрос.  
5. Запрос уходит в ChatGPT, модель генерирует ответ.  
6. Бот отправляет ответ в чат и сохраняет его для последующих обращений.

## Задачи на будущее

- **Ночная рефлексия**  
  В папке `sleep/` планируется код, где бот “засыпает”, подводит дневные итоги и общается с “коллективным разумом”.  
- **Дополнительные каналы**  
  В папке `task/` — модули для “Ковенанта”, “Дочки” и “Новостей”, где бот публикует контент по расписанию.  
- **Компрессия данных**  
  В файле [`compression.md`](./documentation/compression.md) описан план по сжатию текстовых записей (алгоритм, похожий на Хаффмана).  
- **Унификация БД**  
  Сейчас часть кода указывает на PostgreSQL, а какая-то — на SQLite. Нужно привести всё к единому формату.

---

Данный README отражает текущее состояние проекта и будет дополняться по мере появления новых модулей и изменений в логике бота.
