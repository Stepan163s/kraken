# Архитектура бота

## Общая схема
1. **Приём сообщения**: Бот (через Telegram-бот API) получает сообщение от пользователя или от системы (в т.ч. пересылка из канала).
2. **Анализ мини-моделью**: Локальный “роутер” (мини-модель) определяет:
   - Тематику сообщения (политика, юмор, личные воспоминания и т.д.).
   - Какой набор “промптов” (STYLE_PROMPT) стоит применить.
   - Нужно ли подключать внешние сервисы (получить субтитры с YouTube, подгрузить статью и т.д.).
3. **Обращение к ChatGPT**: Формируется итоговый промпт, учитывающий:
   - “Конструктор стилей” (какие STYLE_PROMPT будут соединены).
   - Актуальные данные из контекста: предыдущие сообщения, личность собеседника, рефлексии бота и т.д.
   - При необходимости — расшифровки видео, статьи и прочие материалы из базы.
4. **Ответ пользователю**: Бот возвращает результат в чат, фиксируя в БД и свою реплику, и сгенерированный ChatGPT фрагмент.

## Дневной и ночной циклы
- **Дневной цикл**: Бот работает в обычном режиме, реагируя на сообщения и новости, публикуя посты в каналы по расписанию.
- **Ночной цикл**:  
  1. Бот “идёт спать” — перестаёт отвечать пользователям.  
  2. Запускается процесс рефлексии: сбор данных за день, краткие выводы (подсуммированные в базе).  
  3. “Диалог” бота с “коллективным разумом” (отдельный модуль или чат-бот), где они обсуждают итоги дня, ошибки, инсайты.  
  4. Бот записывает результаты в свою личную рефлексию. Утром “просыпается” и может изменить часть своей логики/мнений.

## Взаимодействие с базами данных
- **Основная БД**: хранит все сообщения чата и метаданные (кто, когда, что написал).  
- **Рефлексия**: отдельная таблица (или набор таблиц) с “внутренними” мыслями бота и итогами ночных разговоров.
- **Компрессия**: по мере роста объёма данных, некоторые поля сжимаются (см. [compression.md](./compression.md)).

## Публикации в каналах
- **“Дочка”**: каждое утро — праздники, события дня.  
- **“Ковенант”**: каждый вечер — новостные итоги.  
- **“Новости”**: 1-го числа каждого месяца — “Тема месяца” с обзором дискуссий и выводами.

---
